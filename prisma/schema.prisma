generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String          @id @default(cuid())
  openId       String          @unique
  unionId      String?         @unique
  nickName     String?
  avatarUrl    String?
  gender       Int?
  city         String?
  province     String?
  country      String?
  language     String?
  currency     String          @default("CNY")
  timezone     String          @default("Asia/Shanghai")
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  lastLoginAt  DateTime        @default(now())
  budgets      Budget[]
  chatSessions ChatSession[]
  expenses     Expense[]
  transactions Transaction[]
  preferences  UserPreference?

  @@map("users")
}

model Transaction {
  id                 String          @id @default(cuid())
  amount             Decimal         @db.Decimal(12, 2)
  description        String
  type               TransactionType
  date               DateTime        @default(now())
  categoryId         String?
  location           String?
  latitude           Float?
  longitude          Float?
  imageUrls          String[]
  aiAnalyzed         Boolean         @default(false)
  aiCategory         String?
  aiTags             String[]
  aiConfidence       Float?
  openaiModel        String?
  aiPromptTokens     Int?
  aiCompletionTokens Int?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  userId             String
  category           Category?       @relation(fields: [categoryId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, type])
  @@index([categoryId])
  @@map("transactions")
}

model Category {
  id           String          @id @default(cuid())
  name         String
  icon         String?
  color        String?
  type         TransactionType
  isDefault    Boolean         @default(false)
  sortOrder    Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  expenses     Expense[]
  transactions Transaction[]

  @@unique([name, type])
  @@index([type])
  @@map("categories")
}

model Budget {
  id             String       @id @default(cuid())
  name           String
  amount         Decimal      @db.Decimal(12, 2)
  period         BudgetPeriod
  startDate      DateTime
  endDate        DateTime
  categoryIds    String[]
  alertThreshold Float        @default(0.8)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("budgets")
}

model ChatSession {
  id           String        @id @default(cuid())
  sessionId    String        @unique
  userId       String
  model        String        @default("gpt-3.5-turbo")
  temperature  Float         @default(0.7)
  maxTokens    Int           @default(1000)
  isActive     Boolean       @default(true)
  totalTokens  Int           @default(0)
  messageCount Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  expiresAt    DateTime
  messages     ChatMessage[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@map("chat_sessions")
}

model ChatMessage {
  id               String      @id @default(cuid())
  sessionId        String
  role             MessageRole
  content          String
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  finishReason     String?
  functionCall     Json?
  toolCalls        Json?
  createdAt        DateTime    @default(now())
  session          ChatSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

model UserPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  theme         String   @default("light")
  language      String   @default("zh-CN")
  autoCategory  Boolean  @default(true)
  aiSuggestion  Boolean  @default(true)
  openaiModel   String   @default("gpt-3.5-turbo")
  aiTemperature Float    @default(0.7)
  locationTrack Boolean  @default(false)
  budgetAlert   Boolean  @default(true)
  dailyReminder Boolean  @default(false)
  settings      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model ApiUsage {
  id               String   @id @default(cuid())
  userId           String
  date             DateTime @default(now()) @db.Date
  openaiCalls      Int      @default(0)
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  cost             Decimal  @default(0) @db.Decimal(10, 6)
  chatMessages     Int      @default(0)
  aiAnalysis       Int      @default(0)
  imageAnalysis    Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("api_usage")
}

model Expense {
  id          Int       @id @default(autoincrement())
  amount      Decimal
  description String?
  date        DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  categoryId  String?
  rawText     String?
  category    Category? @relation(fields: [categoryId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId, date])
  @@map("expenses")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum BudgetPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum MessageRole {
  SYSTEM
  USER
  ASSISTANT
  FUNCTION
  TOOL
}
